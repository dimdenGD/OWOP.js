var WebSocketClient = require('ws');
var ws = new WebSocketClient('ws://ourworldofpixels.com:443', undefined, {headers:{'Origin': 'http://ourworldofpixels.com'}});

const readline=require("readline"),fs=require("fs");OJS={RANKS:{ADMIN:3,MODERATOR:2,USER:1,NONE:0},chat:{setNick:function(e){ws.send(`/nick ${e}${OJS.options.misc.chatVerification}`)},tell:function(e,t){OJS.chat.send(`/tell ${e} ${t}`)},send:function(e){ws.send(e+OJS.options.misc.chatVerification)},recvModifier:function(e){Buffer.isBuffer(e)||(console.log("[OWOP.js]: "+e),OJS.chat.messages.push(e))},firstMessage:function(){return OJS.chat.messages[0]},lastMessage:function(){return OJS.chat.messages.reverse()[0]},messages:[]},interact:{input:function(){process.openStdin().on("data",function(e){var t=e.toString().trim();return OJS.chat.send(t)})},ask:function(){var e=readline.createInterface({input:process.stdin,output:process.stdout});e.question("[CHAT_ASK]: ",t=>{OJS.chat.send(t),e.close()})},controller:function(){var stdin=process.openStdin();stdin.on("data",function(d){var msg=d.toString().trim();try{return eval(msg)}catch(e){console.log(e.error)}})},eval:function(){var rl=readline.createInterface({input:process.stdin,output:process.stdout});rl.question("",msg=>{try{eval(msg)}catch(e){console.log(e.error)}rl.close()})}},world:{join:function(e){var t=e,n=[];t=t?t.toLowerCase():"main";for(var r=0;r<t.length&&r<24;r++){var o=t.charCodeAt(r);(o<123&&o>96||o<58&&o>47||95==o||46==o)&&n.push(o)}var s=new ArrayBuffer(n.length+2),a=new DataView(s);for(r=n.length;r--;)a.setUint8(r,n[r]);a.setUint16(n.length,4321,!0),ws.send(s),console.log("[OWOP.js]: Connected! Joining world: "+t)},leave:function(){ws.close()},move:function(e,t){var n=new ArrayBuffer(12),r=new DataView(n);r.setInt32(0,e,!0),r.setInt32(4,t,!0),r.setUint8(8,OJS.player.color[0]),r.setUint8(9,OJS.player.color[1]),r.setUint8(10,OJS.player.color[2]),r.setUint8(11,OJS.player.tool),ws.send(n),OJS.player.x=e,OJS.player.y=t},setPixel:async function(e,t,n){var r=new ArrayBuffer(11),o=new DataView(r);await o.setInt32(0,e,!0),await o.setInt32(4,t,!0),await o.setUint8(8,n[0]),await o.setUint8(9,n[1]),await o.setUint8(10,n[2]),await ws.send(r),OJS.player.color=[n[0],n[1],n[2]]},setColor:function(e){var t=new ArrayBuffer(12),n=new DataView(t);n.setInt32(0,OJS.player.x,!0),n.setInt32(4,OJS.player.y,!0),n.setUint8(8,e[0]),n.setUint8(9,e[1]),n.setUint8(10,e[2]),n.setUint8(11,OJS.player.tool),ws.send(t),OJS.player.color=[e[0],e[1],e[2]]},setTool:function(e){var t=new ArrayBuffer(12),n=new DataView(t);n.setInt32(0,OJS.player.x,!0),n.setInt32(4,OJS.player.y,!0),n.setUint8(8,OJS.player.color[0]),n.setUint8(9,OJS.player.color[1]),n.setUint8(10,OJS.player.color[2]),n.setUint8(11,e),ws.send(t),OJS.player.tool=e}},player:{x:0,y:0,color:[0,0,0],tool:0},options:{class:null,chunkSize:16,netUpdateSpeed:20,clusterChunkAmount:64,maxWorldNameLength:24,worldBorder:1048575,chatBucket:[4,6],tools:{id:{},0:"cursor",1:"move",2:"pipette",3:"eraser",4:"zoom",5:"fill",6:"paste",7:"export",8:"line",9:"protect"},misc:{worldVerification:4321,chatVerification:String.fromCharCode(10),tokenVerification:"CaptchA"},opCode:{client:{},server:{setId:0,worldUpdate:1,chunkLoad:2,teleport:3,setRank:4,captcha:5,setPQuota:6,chunkProtected:7}}},util:{localStorage:{create:function(){fs.appendFile("OJS_LOCALSTORAGE.json","{}",function(e){if(e)throw e})},setItem:function(e,t){if(OJS.util.localStorage.isCreated()){var n=JSON.parse(fs.readFileSync("OJS_LOCALSTORAGE.json"));n[e]=t,console.log(JSON.stringify(n)),fs.writeFileSync("OJS_LOCALSTORAGE.json",JSON.stringify(n))}else console.error("OJS ERROR: LocalStorage is not created!")},getItem:function(e){if(OJS.util.localStorage.isCreated())return JSON.parse(fs.readFileSync("OJS_LOCALSTORAGE.json"))[e];console.error("OJS ERROR: LocalStorage is not created!")},removeItem:function(e){if(OJS.util.localStorage.isCreated()){var t=JSON.parse(fs.readFileSync("OJS_LOCALSTORAGE.json"));delete t[e],fs.writeFileSync("OJS_LOCALSTORAGE.json",JSON.stringify(t))}else console.error("OJS ERROR: LocalStorage is not created!")},clearStorage:function(){fs.writeFileSync("OJS_LOCALSTORAGE.json","{}")},isCreated:function(){return!(!fs.existsSync("OJS_LOCALSTORAGE.json")||null==fs.readFileSync("OJS_LOCALSTORAGE.json")||""==fs.readFileSync("OJS_LOCALSTORAGE.json"))}}}};

ws.onopen = async function () {
await OJS.world.join('main');
await OJS.chat.setNick('OJS Bot');
await OJS.interact.controller()
};
ws.onmessage = function (data) {
msg = data.data;
    OJS.chat.recvModifier(msg);
}
